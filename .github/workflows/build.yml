name: Build APK - OneSignal Push

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

      - name: Install Flet and Python dependencies
        run: pip install -r requirements.txt

      - name: Write Firebase & Google Sheets config files
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GCP_GSHEET_CREDS: ${{ secrets.GCP_GSHEET_CREDS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: |
          mkdir -p assets
          echo "$FIREBASE_SERVICE_ACCOUNT" > assets/firebase_service_account.json
          echo "$GCP_GSHEET_CREDS" > assets/gsheet_creds.json
          echo "{\"sheet_id\": \"${GOOGLE_SHEET_ID}\"}" > assets/gsheet_config.json

          mkdir -p android/app
          echo "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

          echo "=== Verifying config files ==="
          ls -lh assets/
          ls -lh android/app/google-services.json
          echo "=============================="

      - name: Flutter pub get
        run: flutter pub get

      - name: Generate launcher icons
        run: flutter pub run flutter_launcher_icons

      - name: Verify required secrets exist (no secret printing)
        env:
          ONESIGNAL_REST_API_KEY: ${{ secrets.ONESIGNAL_REST_API_KEY }}
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
        run: |
          if [ -z "$ONESIGNAL_REST_API_KEY" ]; then
            echo "âŒ Missing secret: ONESIGNAL_REST_API_KEY"
            exit 1
          fi
          if [ -z "$ONESIGNAL_APP_ID" ]; then
            echo "âŒ Missing secret: ONESIGNAL_APP_ID"
            exit 1
          fi
          echo "âœ… OneSignal secrets present."

      - name: Build APK with Flet
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          GCP_GSHEET_CREDS: ${{ secrets.GCP_GSHEET_CREDS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

          # âœ… OneSignal via Secrets (NO hardcode in repo)
          ONESIGNAL_REST_API_KEY: ${{ secrets.ONESIGNAL_REST_API_KEY }}
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
        run: |
          echo "ðŸ”¨ Building Chat App with OneSignal support..."
          flet build apk --verbose

      - name: Collect APK
        run: |
          APK_PATH=$(find . -name "*.apk" | head -n 1)
          echo "Found APK at: $APK_PATH"

          if [ -f "$APK_PATH" ]; then
            cp "$APK_PATH" ChatApp.apk
            echo "âœ… APK copied successfully"
            ls -lh ChatApp.apk
          else
            echo "âŒ ERROR: No APK found!"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChatApp-APK
          path: ChatApp.apk
          retention-days: 7

      - name: Build Summary
        run: |
          echo "## âœ… Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Details" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** ChatApp.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** com.flet.chat_app" >> $GITHUB_STEP_SUMMARY
          echo "- **OneSignal:** Enabled (secrets-based)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”” OneSignal Config" >> $GITHUB_STEP_SUMMARY
          echo "- Uses GitHub Secrets: \`ONESIGNAL_APP_ID\`, \`ONESIGNAL_REST_API_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Testing Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download APK from Artifacts above" >> $GITHUB_STEP_SUMMARY
          echo "2. Install on Android device" >> $GITHUB_STEP_SUMMARY
          echo "3. Login to app" >> $GITHUB_STEP_SUMMARY
          echo "4. Wait 15 seconds" >> $GITHUB_STEP_SUMMARY
          echo "5. Check \`adb logcat | findstr PUSH-DEBUG\`" >> $GITHUB_STEP_SUMMARY
          echo "6. Verify OneSignal Dashboard shows new user" >> $GITHUB_STEP_SUMMARY
